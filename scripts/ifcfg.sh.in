#!/bin/sh
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Copyright (C) 2018 - David Oberhollenzer
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
CFGPATH="@ETCPATH@/netcfg"

[ -d "$CFGPATH" ] || exit 0

# configure interfaces
for IFPATH in /sys/class/net/*; do
	[ "$IFPATH" == "/sys/class/net/lo" ] && continue

	IF=`basename $IFPATH`
	CFGFILE="$CFGPATH/$IF"

	[ -f "$CFGFILE" ] || continue

	ip link set dev "$IF" down

	while read LINE;
	do
		trimmed=`echo -- $LINE`
		[ ! -z "$trimmed" ] || continue
		set $trimmed

		case "$1" in
		address|addr|ip|ip6|ipv6)
			shift
			ip address add $@ dev "$IF"
			;;
		arp|multicast|mtu)
			ip link set dev "$IF" $@
			;;
		offload)
			shift
			ethtool -K "$IF" $@
			;;
		*)
			;;
		esac
	done < "$CFGFILE"
done

# configure static routs
if [ -f "$CFGPATH/routes" ]; then
	while read LINE;
	do
		trimmed=`echo -- $LINE`
		[ ! -z "$trimmed" ] || continue
		set $trimmed

		case "$1" in
		route)
			shift
			ip route add $@
			;;
		rule)
			shift
			ip rule add $@
			;;
		*)
			;;
		esac
	done < "$CFGFILE"
fi

# activate interfaces
for IFPATH in /sys/class/net/*; do
	[ "$IFPATH" == "/sys/class/net/lo" ] && continue

	IF=`basename $IFPATH`

	[ ! -f "$CFGPATH/$IF" ] || ip link set dev "$IF" up
done
